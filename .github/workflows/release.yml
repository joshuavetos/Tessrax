---
# yamllint disable rule:truthy
name: Release Packager

on:
  workflow_call:
  push:
    tags:
      - 'v19.*'

jobs:
  package:
    runs-on: ubuntu-latest
    env:
      TESSRAX_PUBLISH_GH: ${{ secrets.TESSRAX_PUBLISH_GH || '0' }}
      TWINE_REPOSITORY_URL: ${{ secrets.TWINE_REPOSITORY_URL || '' }}
      TWINE_USERNAME: ${{ secrets.TWINE_USERNAME || '' }}
      TWINE_PASSWORD: ${{ secrets.TWINE_PASSWORD || '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install packaging dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e . --upgrade
          pip install -r requirements.txt || true
          pip install wheel twine
      - name: Execute release packager
        env:
          TESSRAX_PUBLISH_GH: ${{ secrets.TESSRAX_PUBLISH_GH || '0' }}
          TWINE_REPOSITORY_URL: ${{ secrets.TWINE_REPOSITORY_URL || '' }}
          TWINE_USERNAME: ${{ secrets.TWINE_USERNAME || '' }}
          TWINE_PASSWORD: ${{ secrets.TWINE_PASSWORD || '' }}
        run: |
          python scripts/package_release.py
      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tessrax-v19-release
          path: |
            out/Tessrax-v19-release.tar.gz
            out/Tessrax-v19-release.whl
            out/release_packager_receipt.json
      - name: Publish wheel via twine (if secrets provided)
        if: ${{ env.TWINE_USERNAME != '' && env.TWINE_PASSWORD != '' && env.TWINE_REPOSITORY_URL != '' }}
        env:
          TWINE_REPOSITORY_URL: ${{ secrets.TWINE_REPOSITORY_URL }}
          TWINE_USERNAME: ${{ secrets.TWINE_USERNAME }}
          TWINE_PASSWORD: ${{ secrets.TWINE_PASSWORD }}
        run: |
          python -m twine upload --non-interactive out/Tessrax-v19-release.whl
