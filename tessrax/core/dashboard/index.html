<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Tessrax Ledger Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui, sans-serif;background:#0c0c0c;color:#f1f1f1;margin:0;padding:2rem}
    h1{font-weight:500;margin-bottom:0.25rem}
    .root{font-family:monospace;color:#8cf}
    table{border-collapse:collapse;margin-top:1rem;width:100%}
    th,td{padding:.5rem .75rem;border-bottom:1px solid #333;text-align:left}
    tr:hover{background:#111}
    .ok{color:#6f6}
    .fail{color:#f66}
    #proofs code{display:block;margin:.25rem 0;background:#111;padding:.25rem .5rem;border-radius:4px}
  </style>
</head>
<body>
  <h1>üß≠ Tessrax Ledger Dashboard</h1>
  <p>Live view of anchored Merkle roots and verification results.</p>
  <section id="status"></section>
  <section id="anchors">
    <h2>Anchored Roots</h2>
    <table><thead><tr><th>Root</th><th>Anchored</th><th>Timestamp</th><th>Proofs</th></tr></thead>
      <tbody id="anchorTable"></tbody>
    </table>
  </section>
  <section id="verify">
    <h2>Verify Receipt</h2>
    <p>Enter <code>source_hash</code> from any receipt:</p>
    <input id="hashInput" style="width:60%" placeholder="source_hash...">
    <button onclick="verifyReceipt()">Verify</button>
    <div id="verifyResult"></div>
  </section>

<script>
const API = window.location.origin.replace(/\/$/, '') || "http://localhost:8000";

// Load basic status
fetch(API+'/')
  .then(r=>r.json())
  .then(j=>document.getElementById('status').innerHTML=
        `<p><b>${j.service}</b> ‚Äî ${j.status}</p><p>${j.description}</p>`)
  .catch(()=>document.getElementById('status').innerText='API unreachable.');

// Load anchors
async function loadAnchors(){
  const res = await fetch('/logs/anchor_log.jsonl');
  if(!res.ok){document.getElementById('anchorTable').innerHTML="<tr><td colspan=4>No anchor log.</td></tr>";return;}
  const text = await res.text();
  const rows = text.trim().split('\n').slice(-20).reverse();
  const tbody=document.getElementById('anchorTable');
  tbody.innerHTML='';
  rows.forEach(line=>{
    const j=JSON.parse(line);
    const proofs=j.proofs.map(p=>p.cid?`<code>${p.cid}</code>`:`<code>${p.proof}</code>`).join('');
    tbody.insertAdjacentHTML('beforeend',
      `<tr><td class="root">${j.root.slice(0,12)}‚Ä¶</td><td class="ok">‚úì</td><td>${new Date(j.timestamp*1000).toLocaleString()}</td><td id="proofs">${proofs}</td></tr>`);
  });
}
loadAnchors();

// Verify single receipt
async function verifyReceipt(){
  const h=document.getElementById('hashInput').value.trim();
  if(!h) return;
  const body={source_hash:h,contradiction_score:0,timestamp:0};
  const r=await fetch(API+'/verify/receipt',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  const res=document.getElementById('verifyResult');
  if(!r.ok){res.innerHTML=`<p class='fail'>‚ùå Not found</p>`;return;}
  const j=await r.json();
  res.innerHTML=`<p class='ok'>‚úÖ Included in ledger</p>
  <p>Root: <code>${j.root.slice(0,12)}‚Ä¶</code></p>
  <p>Anchored: ${j.anchored ? 'yes' : 'no'}</p>`;
}
</script>
</body>
</html>